rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // --- HELPER FUNCTIONS ---
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // TODO: Replace with robust Custom Claims or Admin Collection check in production.
    // For V2 Beta, we assume specific UIDs or allow writes for dev if needed.
    // Currently restricting to authenticated users with specific emails or a "roles" claim.
    function isAdmin() {
      return isAuthenticated() && (
        request.auth.token.email.matches('.*@ubuild[.]pro') || 
        request.auth.token.email in ['aikit.shingala@gmail.com', 'demo@tejas.com'] 
      );
    }

    // --- VOLUNTEERS ---
    // Public read for check-in kiosk mode.
    // Allow updates for check-in status (lastActive, status)
    match /volunteers/{userId} {
      allow read: if true; // Public read for kiosk check-in
      allow create: if isOwner(userId) || isAdmin();
      allow update: if true; // Allow kiosk to update status/lastActive
      allow delete: if isAdmin();
    }

    // --- ASSIGNMENTS ---
   // Public read for check-in kiosk mode.
    // Allow updates for check-in times
    match /assignments/{assignmentId} {
      allow read: if true; // Public read for kiosk check-in
      allow create: if isAdmin();
      allow update: if true; // Allow kiosk to update actualCheckIn/status
      allow delete: if isAdmin();
    }

   // --- CHECK-INS ---
    // Allow kiosk mode (unauthenticated) to create check-ins.
    // Authenticated volunteers can also create their own check-ins.
    match /checkins/{checkinId} {
      allow create: if true; // Allow kiosk check-ins without auth
      allow read: if isAuthenticated() && (
        resource.data.volunteerId == request.auth.uid || isAdmin()
      );
      allow update, delete: if isAdmin();
    }

    // --- TICKETS (Issue Reporting) ---
    // Volunteers can create tickets.
    // They can read their own tickets.
    // Admins see the full queue.
    match /tickets/{ticketId} {
      allow create: if isAuthenticated() && (
        request.resource.data.reporterId == request.auth.uid
      );
      allow read: if isAuthenticated() && (
        resource.data.reporterId == request.auth.uid || isAdmin()
      );
      allow update, delete: if isAdmin();
    }

    // --- ALERTS ---
    // Command Center feed. Private to Admins (or specific target audiences).
    // For now, restricting to Admins as per V2 spec.
    match /alerts/{alertId} {
      allow read, write: if isAdmin();
    }
    
    // --- ROADMAP & BLOCKERS (Strategy Room) ---
    // Publicly readable for the team/stakeholders?
    // User didn't specify, but Strategy Room is generally internal.
    // We'll allow authenticated read to support the Dashboard.
    match /roadmap_phases/{phaseId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin();
    }
    
    match /project_blockers/{blockerId} {
      allow read: if isAuthenticated();
      allow write: if isAdmin() || isAuthenticated(); // Allow team updates for now (Mark Resolved)
    }
  }
}
